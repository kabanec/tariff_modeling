<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Avalara Total Landed Cost Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f5f7f9; color: #1a2332; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0; }
        .app-header { background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%); color: white; padding: 32px 40px; margin-bottom: 0; box-shadow: 0 4px 12px rgba(255, 102, 0, 0.15); }
        .app-header h1 { font-size: 2rem; font-weight: 600; margin-bottom: 8px; letter-spacing: -0.5px; }
        .app-header p { font-size: 1rem; opacity: 0.95; font-weight: 400; }
        .main-content { padding: 24px 40px 40px; background: white; }
        .form-section { background: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .form-section h2 { font-size: 1.25rem; font-weight: 600; color: #1a2332; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0; }
        .header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 0; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; color: #1a2332; font-size: 0.875rem; letter-spacing: 0.02em; white-space: nowrap; }
        label .required { color: #ff6600; margin-left: 2px; }
        input, select { padding: 10px 14px; border: 1.5px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; background: white; color: #1a2332; transition: all 0.2s ease; font-family: inherit; }
        input:focus, select:focus { outline: none; border-color: #ff6600; box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1); }
        input:hover:not(:disabled), select:hover:not(:disabled) { border-color: #ff6600; }
        input[type="date"] { cursor: pointer; }
        input:disabled, select:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; }
        .order-details { display: flex; gap: 24px; align-items: flex-end; margin-top: 0; }
        .order-details .input-group { flex: 0 0 auto; }
        .order-details .input-group input[type="number"] { max-width: 150px; }
        .checkbox-group { display: flex; align-items: center; padding: 8px; margin: 0; min-height: 50px; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; cursor: pointer; accent-color: #ff6600; }
        .checkbox-group label { margin: 0; cursor: pointer; font-weight: 500; font-size: 0.875rem; }
        .vendors { display: grid; grid-template-columns: 200px repeat(6, 1fr); gap: 1px; background: #e5e7eb; border-radius: 8px; overflow: hidden; margin-top: 20px; }
        .vendors .label-col { background: #fff9e6; padding: 12px 16px; display: flex; flex-direction: column; gap: 1px; position: sticky; left: 0; z-index: 10; }
        .vendors .label-col .input-group { min-height: 50px; display: flex; align-items: center; justify-content: flex-start; background: #fff9e6; padding: 8px; border-radius: 4px; }
        .vendors .label-col .input-group label { margin: 0; font-size: 0.875rem; font-weight: 600; color: #1a2332; text-align: left; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto; line-height: 1.4; width: 100%; }
        .vendors .vendor-col { background: white; padding: 12px; display: flex; flex-direction: column; gap: 1px; border-right: 1px solid #e5e7eb; transition: all 0.3s ease; }
        .vendors .vendor-col:last-child { border-right: none; }
        .vendors .vendor-col.cheapest-vendor { background: #f0fdf4; border: 3px solid #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .vendors .vendor-col .input-group { min-height: 50px; display: flex; flex-direction: column; justify-content: center; padding: 0; }
        .vendors input, .vendors select { width: 100%; padding: 8px 12px; font-size: 0.875rem; border-radius: 6px; }
        .vendors input[readonly] { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .vendor-results-container { display: flex; flex-direction: column; gap: 1px; width: 100%; }
        .vendor-results-container .result-field { background: #fef3f0; padding: 12px; border-radius: 6px; text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; color: #1a2332; border: 1px solid #fed7cc; }
        .vendor-results-container .total-cost-result { font-weight: 700; font-size: 1.1rem; border: 2px solid; }
        .result-labels-container { display: flex; flex-direction: column; gap: 1px; width: 100%; }
        .result-labels-container .input-group { min-height: 60px; display: flex; align-items: center; background: #fff9e6; padding: 10px; border-radius: 4px; }
        .result-labels-container .input-group label { margin: 0; font-size: 0.875rem; text-align: left; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.4; width: 100%; }
        .result-labels-container .total-cost-label { background: #fff3cd; font-weight: 700; }
        .result-labels-container .total-cost-label label { font-size: 1rem; font-weight: 700; }
        .loading { padding: 20px; text-align: center; font-size: 1rem; color: #ff6600; font-weight: 600; }
        .error { color: #dc2626; font-weight: 600; text-align: center; padding: 10px; background: #fef2f2; border-radius: 6px; border: 1px solid #fecaca; }
        .button-group { display: flex; justify-content: center; gap: 16px; margin: 32px 0 24px; }
        button { padding: 14px 32px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s ease; font-family: inherit; letter-spacing: 0.02em; }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        button:active { transform: translateY(0); }
        .run-btn { background: linear-gradient(135deg, #006B7D 0%, #008B9F 100%); color: white; box-shadow: 0 2px 8px rgba(0, 107, 125, 0.2); }
        .run-btn:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; transform: none; }
        .save-btn { background: #ff6600; color: white; box-shadow: 0 2px 8px rgba(255, 102, 0, 0.2); }
        .debug-btn { background: white; color: #6b7280; border: 1.5px solid #d1d5db; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        #hs_code { background-color: #f0f9ff; border-color: #93c5fd; }
        .footer { text-align: center; padding: 24px; color: #9ca3af; font-size: 0.875rem; background: white; border-top: 1px solid #e5e7eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>Avalara Total Landed Cost</h1>
            <p>Calculate complete landed costs including duties, taxes, and logistics</p>
        </div>
        <div class="main-content">
            <form method="POST" id="mainForm" onsubmit="return validateForm(event)">
                <div class="form-section">
                    <h2>Product & Import Details</h2>
                    <div class="header">
                        <div class="input-group"><label>Import Date <span class="required">*</span></label><input type="date" name="import_date" id="import_date" value="" required></div>
                        <div class="input-group"><label>Import Country <span class="required">*</span></label><select name="import_country" required><option value="US" selected>ğŸ‡ºğŸ‡¸ United States</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                        <div class="input-group"><label>Part # / SKU</label><input type="text" name="part_sku" value="" placeholder="Enter SKU"></div>
                        <div class="input-group"><label>Product Name / Description <span class="required">*</span></label><div style="display: flex; gap: 8px;"><input type="text" name="description" id="description" value="" required placeholder="Enter description" style="flex: 1;"><button type="button" id="classifyBtn" style="padding: 10px 20px; background: #006B7D; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">Classify</button></div></div>
                        <div class="input-group"><label>HS Code <span class="required">*</span></label><input type="text" name="hs_code" id="hs_code" value="" placeholder="e.g., 6307909891" maxlength="10" required></div>
                    </div>
                </div>
                <div id="classification-widget" style="display: none; margin-bottom: 20px; border: 2px solid #ff6600; border-radius: 12px; padding: 20px; background: #fff;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #1a2332; font-size: 1.1rem;">Product Classification</h3>
                        <button type="button" id="closeWidget" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                    </div>
                    <div id="widget-container" style="height: 600px; border: 1px solid #e5e7eb; border-radius: 8px;"></div>
                </div>
                <div class="form-section">
                    <h2>Order Details</h2>
                    <div class="order-details">
                        <div class="input-group"><label>Order Qty <span class="required">*</span></label><input type="number" name="order_qty" value="" min="1" required placeholder="Enter quantity"></div>
                    </div>
                </div>
                <div class="form-section">
                    <h2>Vendor Comparison</h2>
                    <div class="vendors">
                        <div class="label-col">
                            <div class="input-group"><label>Vendor Country <span class="required">*</span></label></div>
                            <div class="input-group"><label>COGS (ea) <span class="required">*</span></label></div>
                            <div class="input-group"><label>Incoterm</label></div>
                            <div class="input-group"><label>SPI Applicable</label></div>
                            <div class="input-group"><label>Export Fees ($)</label></div>
                            <div class="input-group"><label>Delivery to Port ($)</label></div>
                            <div class="input-group"><label>Intl. Freight & Insurance ($)</label></div>
                            <div class="input-group"><label>MPF / HMF ($)</label></div>
                            <div class="input-group"><label>Customs Brokerage Fees ($)</label></div>
                            <div class="input-group"><label>Final Delivery ($)</label></div>
                            <div class="input-group"><label>Other ($)</label></div>
                            <div class="result-labels-container"></div>
                        </div>
                        <div class="vendor-col" data-vendor-id="1">
                            <div class="input-group"><select name="vendor_country_1"><option value="">Select</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="US">ğŸ‡ºğŸ‡¸ United States</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                            <div class="input-group"><input type="number" step="0.01" name="cogs_1" min="0.01" placeholder="0.00"></div>
                            <div class="input-group"><select name="incoterm_1" class="incoterm-select"><option value="EXW" selected>EXW</option><option value="DDP">DDP</option></select></div>
                            <div class="checkbox-group"><input type="checkbox" name="spi_1" id="spi_1"><label for="spi_1">SPI</label></div>
                            <div class="input-group"><input type="number" step="0.01" name="export_fees_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="delivery_port_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="intl_freight_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="mpf_hmf_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="brokerage_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="final_delivery_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="other_1" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="vendor-results-container"></div>
                        </div>
                        <div class="vendor-col" data-vendor-id="2">
                            <div class="input-group"><select name="vendor_country_2"><option value="">Select</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="US">ğŸ‡ºğŸ‡¸ United States</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                            <div class="input-group"><input type="number" step="0.01" name="cogs_2" min="0.01" placeholder="0.00"></div>
                            <div class="input-group"><select name="incoterm_2" class="incoterm-select"><option value="EXW" selected>EXW</option><option value="DDP">DDP</option></select></div>
                            <div class="checkbox-group"><input type="checkbox" name="spi_2" id="spi_2"><label for="spi_2">SPI</label></div>
                            <div class="input-group"><input type="number" step="0.01" name="export_fees_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="delivery_port_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="intl_freight_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="mpf_hmf_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="brokerage_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="final_delivery_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="other_2" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="vendor-results-container"></div>
                        </div>
                        <div class="vendor-col" data-vendor-id="3">
                            <div class="input-group"><select name="vendor_country_3"><option value="">Select</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="US">ğŸ‡ºğŸ‡¸ United States</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                            <div class="input-group"><input type="number" step="0.01" name="cogs_3" min="0.01" placeholder="0.00"></div>
                            <div class="input-group"><select name="incoterm_3" class="incoterm-select"><option value="EXW" selected>EXW</option><option value="DDP">DDP</option></select></div>
                            <div class="checkbox-group"><input type="checkbox" name="spi_3" id="spi_3"><label for="spi_3">SPI</label></div>
                            <div class="input-group"><input type="number" step="0.01" name="export_fees_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="delivery_port_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="intl_freight_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="mpf_hmf_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="brokerage_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="final_delivery_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="other_3" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="vendor-results-container"></div>
                        </div>
                        <div class="vendor-col" data-vendor-id="4">
                            <div class="input-group"><select name="vendor_country_4"><option value="">Select</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="US">ğŸ‡ºğŸ‡¸ United States</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                            <div class="input-group"><input type="number" step="0.01" name="cogs_4" min="0.01" placeholder="0.00"></div>
                            <div class="input-group"><select name="incoterm_4" class="incoterm-select"><option value="EXW" selected>EXW</option><option value="DDP">DDP</option></select></div>
                            <div class="checkbox-group"><input type="checkbox" name="spi_4" id="spi_4"><label for="spi_4">SPI</label></div>
                            <div class="input-group"><input type="number" step="0.01" name="export_fees_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="delivery_port_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="intl_freight_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="mpf_hmf_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="brokerage_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="final_delivery_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="other_4" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="vendor-results-container"></div>
                        </div>
                        <div class="vendor-col" data-vendor-id="5">
                            <div class="input-group"><select name="vendor_country_5"><option value="">Select</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="US">ğŸ‡ºğŸ‡¸ United States</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                            <div class="input-group"><input type="number" step="0.01" name="cogs_5" min="0.01" placeholder="0.00"></div>
                            <div class="input-group"><select name="incoterm_5" class="incoterm-select"><option value="EXW" selected>EXW</option><option value="DDP">DDP</option></select></div>
                            <div class="checkbox-group"><input type="checkbox" name="spi_5" id="spi_5"><label for="spi_5">SPI</label></div>
                            <div class="input-group"><input type="number" step="0.01" name="export_fees_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="delivery_port_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="intl_freight_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="mpf_hmf_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="brokerage_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="final_delivery_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="other_5" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="vendor-results-container"></div>
                        </div>
                        <div class="vendor-col" data-vendor-id="6">
                            <div class="input-group"><select name="vendor_country_6"><option value="">Select</option><option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option><option value="AU">ğŸ‡¦ğŸ‡º Australia</option><option value="BE">ğŸ‡§ğŸ‡ª Belgium</option><option value="BR">ğŸ‡§ğŸ‡· Brazil</option><option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="CN">ğŸ‡¨ğŸ‡³ China</option><option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option><option value="DE">ğŸ‡©ğŸ‡ª Germany</option><option value="DK">ğŸ‡©ğŸ‡° Denmark</option><option value="ES">ğŸ‡ªğŸ‡¸ Spain</option><option value="FI">ğŸ‡«ğŸ‡® Finland</option><option value="FR">ğŸ‡«ğŸ‡· France</option><option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="GR">ğŸ‡¬ğŸ‡· Greece</option><option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option><option value="ID">ğŸ‡®ğŸ‡© Indonesia</option><option value="IE">ğŸ‡®ğŸ‡ª Ireland</option><option value="IN">ğŸ‡®ğŸ‡³ India</option><option value="IT">ğŸ‡®ğŸ‡¹ Italy</option><option value="JP">ğŸ‡¯ğŸ‡µ Japan</option><option value="KR">ğŸ‡°ğŸ‡· South Korea</option><option value="MX">ğŸ‡²ğŸ‡½ Mexico</option><option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option><option value="NL">ğŸ‡³ğŸ‡± Netherlands</option><option value="NO">ğŸ‡³ğŸ‡´ Norway</option><option value="PH">ğŸ‡µğŸ‡­ Philippines</option><option value="PL">ğŸ‡µğŸ‡± Poland</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option><option value="RU">ğŸ‡·ğŸ‡º Russia</option><option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option><option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option><option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option><option value="TR">ğŸ‡¹ğŸ‡· Turkey</option><option value="US">ğŸ‡ºğŸ‡¸ United States</option><option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option></select></div>
                            <div class="input-group"><input type="number" step="0.01" name="cogs_6" min="0.01" placeholder="0.00"></div>
                            <div class="input-group"><select name="incoterm_6" class="incoterm-select"><option value="EXW" selected>EXW</option><option value="DDP">DDP</option></select></div>
                            <div class="checkbox-group"><input type="checkbox" name="spi_6" id="spi_6"><label for="spi_6">SPI</label></div>
                            <div class="input-group"><input type="number" step="0.01" name="export_fees_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="delivery_port_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="intl_freight_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="mpf_hmf_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="brokerage_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="final_delivery_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="input-group"><input type="number" step="0.01" name="other_6" class="cost-field" min="0" placeholder="0.00" value="0"></div>
                            <div class="vendor-results-container"></div>
                        </div>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="debug-btn" onclick="window.location.href='/'">â† Back to Tariff Modeling</button>
                    <button type="submit" id="run-btn" class="run-btn" disabled>Calculate Landed Cost</button>
                    <button type="button" class="save-btn" onclick="exportToExcel()">Save Results</button>
                </div>
            </form>
        </div>
        <div class="footer">Â© Avalara, Inc. 2025</div>
    </div>

    <!-- Classification Widget Script -->
    <script
        id="ccce-script"
        data-element-id="widget-container"
        src="https://hscode-self-classify.sbx.avalara.com/embed.js"
        runOnload="false">
    </script>

    <script>
// Wait for widget script to load
let ccceReady = false;
const checkCCCE = setInterval(() => {
    if (typeof ccce !== 'undefined') {
        ccceReady = true;
        clearInterval(checkCCCE);
        console.log('âœ“ Classification widget loaded successfully');
    }
}, 100);

// Classification widget integration
document.getElementById('classifyBtn').addEventListener('click', function() {
    console.log('>>> Classify button clicked');
    const description = document.getElementById('description').value.trim();
    if (!description) {
        alert('Please enter a product description first');
        return;
    }
    if (!ccceReady || typeof ccce === 'undefined') {
        console.error('âŒ Widget not ready');
        alert('Classification widget is still loading. Please wait a moment and try again.');
        return;
    }
    const destination = document.querySelector('select[name="import_country"]').value;
    let origin = 'US';
    for (let i = 1; i <= 6; i++) {
        const vendorCountry = document.querySelector(`select[name="vendor_country_${i}"]`);
        if (vendorCountry && vendorCountry.value) {
            origin = vendorCountry.value;
            break;
        }
    }
    console.log('ğŸ“‹ Parameters:', {destination: destination, origin: origin, description: description});
    const widgetContainer = document.getElementById('classification-widget');
    widgetContainer.style.display = 'block';
    setTimeout(() => {widgetContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });}, 100);
    const script = document.getElementById('ccce-script');
    console.log('ğŸ”§ Setting script attributes...');
    script.setAttribute('env', 'sbx');
    script.setAttribute('data-profile-id', '2007305446');
    script.setAttribute('cip', '');
    const optionalAttrs = ['debug', 'verbose', 'forceTheme', 'no-shadow'];
    optionalAttrs.forEach(attr => script.removeAttribute(attr));
    console.log('ğŸ”„ Resetting component...');
    if (ccce._loaded) {
        ccce._loaded = false;
        ccce._unload();
    }
    try {
        console.log('âš™ï¸  Initializing CCCE widget...');
        ccce.init(script);
        const params = {product: description, destination: destination, origin: origin, lang: 'English', avaTaxId: '2007305446', avaCustomerId: '00000', hs6: false, useKeyboard: false, useLinkOut: false, useTypeform: true, hideTheme: false, hideClose: false};
        console.log('ğŸš€ Starting classification with params:', JSON.stringify(params, null, 2));
        ccce.classify(params,
            function(data) {
                console.log('âœ… Classification Success:', data);
                if (data && data.hsCode) {
                    document.getElementById('hs_code').value = data.hsCode;
                    document.getElementById('hs_code').style.backgroundColor = '#d1fae5';
                    document.getElementById('hs_code').style.borderColor = '#10b981';
                    console.log('âœ“ HS Code set to:', data.hsCode);
                } else {
                    console.warn('âš ï¸  No HS code in response:', data);
                }
                widgetContainer.style.display = 'none';
            },
            function(err) {
                console.warn('âš ï¸  Classification Aborted or Error:', err);
                widgetContainer.style.display = 'none';
            }
        );
    } catch(e) {
        console.error('âŒ Widget initialization error:', e);
        console.error('Stack trace:', e.stack);
        alert('Error initializing classification widget: ' + e.message);
        widgetContainer.style.display = 'none';
    }
});

document.getElementById('closeWidget').addEventListener('click', function() {
    document.getElementById('classification-widget').style.display = 'none';
});
    </script>
    <script>
document.addEventListener('DOMContentLoaded',function(){
    const i=document.getElementById('import_date');
    const params=new URLSearchParams(window.location.search);

    if(params.has('date')){
        i.value=params.get('date');
        document.querySelector('select[name="import_country"]').value=params.get('country')||'US';
        document.querySelector('input[name="part_sku"]').value=params.get('sku')||'';
        document.querySelector('input[name="description"]').value=params.get('description')||'';
        document.querySelector('input[name="hs_code"]').value=params.get('hsCode')||'';
        document.querySelector('input[name="order_qty"]').value=params.get('qty')||'';

        if(params.has('vendors')){
            try{
                const vendors=JSON.parse(params.get('vendors'));
                vendors.forEach((v,idx)=>{
                    if(idx<6){
                        const vendorId=idx+1;
                        document.querySelector(`select[name="vendor_country_${vendorId}"]`).value=v.country;
                        document.querySelector(`input[name="cogs_${vendorId}"]`).value=v.cogs;
                    }
                });
            }catch(e){console.error('Error parsing vendors',e);}
        }
        validateForm();
    }else if(!i.value){
        const t=new Date();
        i.value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
    }

    // Setup incoterm change listeners
    document.querySelectorAll('.incoterm-select').forEach(select => {
        select.addEventListener('change', function() {
            handleIncotermChange(this);
        });
    });

    // Special listener for Vendor 1 incoterm - cascade if all are synchronized
    const vendor1Incoterm = document.querySelector('select[name="incoterm_1"]');
    if (vendor1Incoterm) {
        vendor1Incoterm.addEventListener('change', function() {
            cascadeIncotermIfSynchronized(this);
        });
    }
});

// Cascade incoterm change from Vendor 1 if all vendors are synchronized
function cascadeIncotermIfSynchronized(vendor1Select) {
    const newValue = vendor1Select.value;

    // Get all other vendor incoterm selects (2-6)
    const otherSelects = [];
    for (let i = 2; i <= 6; i++) {
        const select = document.querySelector(`select[name="incoterm_${i}"]`);
        if (select) {
            otherSelects.push(select);
        }
    }

    if (otherSelects.length === 0) return;

    // Check if all other vendors have the same incoterm value (synchronized)
    const firstValue = otherSelects[0].value;
    const allSame = otherSelects.every(select => select.value === firstValue);

    if (allSame) {
        // They're all synchronized, so update them all to match Vendor 1
        otherSelects.forEach(select => {
            select.value = newValue;
            handleIncotermChange(select); // Trigger the enable/disable logic
        });
        console.log(`âœ“ Cascaded Incoterm to all vendors: ${newValue}`);
    } else {
        console.log(`âœ— Vendors not synchronized, only updated Vendor 1`);
    }
}

// Handle incoterm change (EXW/DDP)
function handleIncotermChange(selectElement) {
    const vendorId = selectElement.name.match(/\d+/)[0];
    const incoterm = selectElement.value;
    const vendor = selectElement.closest('.vendor-col');
    const costFields = vendor.querySelectorAll('.cost-field');

    if (incoterm === 'DDP') {
        // Gray out and set to 0
        costFields.forEach(field => {
            field.disabled = true;
            field.value = '0';
        });
    } else {
        // Enable fields
        costFields.forEach(field => {
            field.disabled = false;
        });
    }
}

function validateForm(event){
    if(event)event.preventDefault();
    const hs=document.getElementById('hs_code').value;
    if(!hs){
        document.getElementById('run-btn').disabled=true;
        return false;
    }
    const vendors=document.querySelectorAll('.vendor-col');
    let hasValid=false;
    vendors.forEach(v=>{
        const id=v.dataset.vendorId;
        const country=v.querySelector(`select[name="vendor_country_${id}"]`).value;
        const cogs=v.querySelector(`input[name="cogs_${id}"]`).value;
        if(country&&cogs&&parseFloat(cogs)>0)hasValid=true;
    });
    document.getElementById('run-btn').disabled=!hasValid;
    return hasValid;
}

document.getElementById('mainForm').addEventListener('input',validateForm);
document.getElementById('mainForm').addEventListener('change',validateForm);

document.getElementById('mainForm').addEventListener('submit',async function(event){
    event.preventDefault();
    if(!validateForm())return;
    const formData=new FormData(this);
    const vendors=document.querySelectorAll('.vendor-col');

    for(let i=0;i<vendors.length;i++){
        const vendor=vendors[i];
        const vendorId=vendor.dataset.vendorId;
        const country=vendor.querySelector(`select[name="vendor_country_${vendorId}"]`).value;
        const cogs=parseFloat(vendor.querySelector(`input[name="cogs_${vendorId}"]`).value)||0;
        const incoterm=vendor.querySelector(`select[name="incoterm_${vendorId}"]`).value;
        const spiChecked=vendor.querySelector(`input[name="spi_${vendorId}"]`).checked;
        const quantity=parseInt(formData.get('order_qty'));

        const resultsContainer=vendor.querySelector('.vendor-results-container');
        resultsContainer.innerHTML='';

        if(country&&cogs>0){
            if(incoterm === 'DDP'){
                // DDP: No API call, just COGS Ã— Quantity
                updateResultLabels();

                const tariffDiv=document.createElement('div');
                tariffDiv.className='result-field';
                tariffDiv.innerHTML=`<span>0%</span>`;
                resultsContainer.appendChild(tariffDiv);

                const dutyDiv=document.createElement('div');
                dutyDiv.className='result-field';
                dutyDiv.innerHTML=`<span>$0.00</span>`;
                resultsContainer.appendChild(dutyDiv);

                const shippingDiv=document.createElement('div');
                shippingDiv.className='result-field';
                shippingDiv.innerHTML=`<span>$0.00</span>`;
                resultsContainer.appendChild(shippingDiv);

                const totalCost=cogs*quantity;
                vendor.dataset.totalCost=totalCost;

                const totalDiv=document.createElement('div');
                totalDiv.className='result-field total-cost-result';
                totalDiv.innerHTML=`<span><strong>$${totalCost.toFixed(2)}</strong></span>`;
                resultsContainer.appendChild(totalDiv);

            } else {
                // EXW: Call API
                resultsContainer.innerHTML='<div class="loading">Calculating...</div>';

                const exportFees=parseFloat(vendor.querySelector(`input[name="export_fees_${vendorId}"]`).value)||0;
                const deliveryPort=parseFloat(vendor.querySelector(`input[name="delivery_port_${vendorId}"]`).value)||0;
                const intlFreight=parseFloat(vendor.querySelector(`input[name="intl_freight_${vendorId}"]`).value)||0;
                const mpfHmf=parseFloat(vendor.querySelector(`input[name="mpf_hmf_${vendorId}"]`).value)||0;
                const brokerage=parseFloat(vendor.querySelector(`input[name="brokerage_${vendorId}"]`).value)||0;
                const finalDelivery=parseFloat(vendor.querySelector(`input[name="final_delivery_${vendorId}"]`).value)||0;
                const other=parseFloat(vendor.querySelector(`input[name="other_${vendorId}"]`).value)||0;
                const totalShipping=exportFees+deliveryPort+intlFreight+mpfHmf+brokerage+finalDelivery+other;

                try{
                    const response=await fetch('/calculate_landed_cost',{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({
                            description:formData.get('description'),
                            hs_code:formData.get('hs_code'),
                            vendor_country:country,
                            cogs:cogs,
                            quantity:quantity,
                            import_country:formData.get('import_country'),
                            import_date:formData.get('import_date'),
                            shipping:totalShipping,
                            spi_applicable:spiChecked
                        })
                    });

                    const result=await response.json();
                    resultsContainer.innerHTML='';

                    if(result.success){
                        updateResultLabels();

                        const tariffDiv=document.createElement('div');
                        tariffDiv.className='result-field';
                        tariffDiv.innerHTML=`<span>${result.total_duty_rate}</span>`;
                        resultsContainer.appendChild(tariffDiv);

                        const dutyDiv=document.createElement('div');
                        dutyDiv.className='result-field';
                        dutyDiv.innerHTML=`<span>$${result.total_duty_tax.toFixed(2)}</span>`;
                        resultsContainer.appendChild(dutyDiv);

                        const shippingDiv=document.createElement('div');
                        shippingDiv.className='result-field';
                        shippingDiv.innerHTML=`<span>$${totalShipping.toFixed(2)}</span>`;
                        resultsContainer.appendChild(shippingDiv);

                        const totalCost=(cogs*quantity)+result.total_duty_tax+totalShipping;
                        vendor.dataset.totalCost=totalCost;

                        const totalDiv=document.createElement('div');
                        totalDiv.className='result-field total-cost-result';
                        totalDiv.innerHTML=`<span><strong>$${totalCost.toFixed(2)}</strong></span>`;
                        resultsContainer.appendChild(totalDiv);
                    }else{
                        resultsContainer.innerHTML='<div class="error">Calculation failed</div>';
                    }
                }catch(error){
                    resultsContainer.innerHTML='<div class="error">Calculation failed</div>';
                }
            }
        }
    }
    applyColorCoding();
});

function updateResultLabels(){
    const labelsContainer=document.querySelector('.result-labels-container');
    if(labelsContainer.children.length>0)return;

    const labels=['Total Tariff Rate','Total Import Duties/Tax','Total Shipping Costs & Fees','Total Cost'];
    labels.forEach((label,idx)=>{
        const labelDiv=document.createElement('div');
        labelDiv.className='input-group'+(idx===labels.length-1?' total-cost-label':'');
        labelDiv.innerHTML=`<label><strong>${label}</strong></label>`;
        labelsContainer.appendChild(labelDiv);
    });
}

function applyColorCoding(){
    const vendors=document.querySelectorAll('.vendor-col');
    const vendorCosts=[];

    vendors.forEach(vendor=>{
        if(vendor.dataset.totalCost){
            vendorCosts.push({vendor:vendor,totalCost:parseFloat(vendor.dataset.totalCost)});
        }
    });

    if(vendorCosts.length===0)return;

    vendorCosts.sort((a,b)=>a.totalCost-b.totalCost);
    const minCost=vendorCosts[0].totalCost;
    const maxCost=vendorCosts[vendorCosts.length-1].totalCost;

    vendors.forEach(v=>v.classList.remove('cheapest-vendor'));
    vendorCosts[0].vendor.classList.add('cheapest-vendor');

    vendorCosts.forEach(({vendor,totalCost})=>{
        const totalCostDiv=vendor.querySelector('.total-cost-result');
        if(totalCostDiv){
            const ratio=vendorCosts.length===1?0:(totalCost-minCost)/(maxCost-minCost);
            const r=Math.round(255*ratio);
            const g=Math.round(255*(1-ratio));
            const color=`rgb(${r},${g},0)`;
            const brightness=(r*299+g*587)/1000;
            const textColor=brightness>128?'#000000':'#ffffff';
            totalCostDiv.style.backgroundColor=color;
            totalCostDiv.style.color=textColor;
            totalCostDiv.style.borderColor=color;
        }
    });
}

function exportToExcel(){alert('Excel export coming soon!');}
validateForm();
    </script>
</body>
</html>